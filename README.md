# kaspGO — Внутренняя очередь для фоновой обработки задач

Необходимо реализовать HTTP‑сервис на Go 1.24 (без сторонних библиотек), который принимает задания, складывает их во внутреннюю буферизированную очередь и обрабатывает пулом воркеров с повторными попытками (экспоненциальный бэкофф с джиттером). Сервис должен уметь завершаться корректно по сигналам SIGINT/SIGTERM.

## Функциональные требования

- **Приём задач**: `POST /enqueue`
  - Тело: JSON `{"id":"<string>","payload":"<string>","max_retries":<int>}`.
  - Задание помещается в буферизированную очередь (размер — из конфигурации).
  - Авторизация не требуется.

- **Обработка задач пулом воркеров**
  - Количество воркеров задаётся переменной окружения `WORKERS` (по умолчанию 4).
  - Каждое задание «работает» 100–500 мс (симуляция обработки).
  - 20% задач «падают» (симуляция ошибок) → применяется экспоненциальный бэкофф с джиттером и до `max_retries` повторов.
  - Хранить и обновлять состояние каждого задания: `queued` | `running` | `done` | `failed`.

- **Healthcheck**: `GET /healthz` → `200 OK` при живом сервисе.

- **Грейсфул‑шатдаун (SIGINT/SIGTERM)**
  - Перестаём принимать новые задачи.
  - Дожидаемся завершения обработки уже запущенных задач.

## Ограничения

- Версия Go: **1.24**.
- **Без сторонних библиотек** (стандартная библиотека).
- Конфигурация через переменные окружения:
  - `WORKERS` — количество воркеров, по умолчанию `4`.
  - `QUEUE_SIZE` — размер буферизированной очереди, по умолчанию `64`.
  - `ERROR_RATE` — процент «падающих» задач (0..100), по умолчанию `20`.

## Сборка и запуск

```bash
# Сборка и запуск (см. Makefile)
make build
make start                 # запускает ./bin/app

# Альтернативно с окружением
WORKERS=6 QUEUE_SIZE=128 ERROR_RATE=20 ./bin/app
```

По умолчанию HTTP‑сервер стартует на `:8080`.

## Примеры использования

```bash
# Healthcheck
curl -i http://localhost:8080/healthz

# Поставить задачу в очередь
curl -i -X POST http://localhost:8080/enqueue \
  -H 'Content-Type: application/json' \
  -d '{"id":"task-123","payload":"hello","max_retries":5}'
```

Ожидаемые ответы `/enqueue`:
- `202 Accepted` и тело `{"status":"queued"}` — задача принята в очередь.
- `429 Too Many Requests` — очередь переполнена.
- `503 Service Unavailable` — сервис в процессе остановки либо очередь закрыта.
- `400 Bad Request` / `413 Payload Too Large` / `405 Method Not Allowed` — ошибки запроса.

## Кратко о реализации

- **Очередь**: буферизированный канал с размером `QUEUE_SIZE`.
- **Пул воркеров**: `WORKERS` горутин, каждая берёт задачу из очереди и обрабатывает её.
- **Состояния задач**: хранятся в потокобезопасной структуре (например, `map[string]State` под мьютексом) и обновляются при переходах: `queued → running → done|failed`.
- **Симуляция работы**: случайная задержка 100–500 мс.
- **Ошибки и ретраи**: ~20% обработок считаются неуспешными; перед повтором — экспоненциальный бэкофф с джиттером до `max_retries` попыток.
- **Грейсфул‑шатдаун**: по сигналу останавливаем приём новых задач и корректно завершаем активные воркеры, дожидаясь их завершения.

Доступны статические маршруты: `GET /swagger/*` и `GET /docs/*`.

## Тестирование

```bash
# Покрытие тестов
make coverage        # вывод покрытия в консоль
make coverage-html   # HTML‑отчёт в coverage/coverage.html
```

## Структура проекта (предполагаемая)

- `cmd/app` — точка входа HTTP‑сервера (`main.go`).
- `internal/app` — инициализация HTTP‑маршрутов, запуск воркеров, graceful shutdown.
- `internal/jobqueue` — очередь задач и хранение состояний.
- `internal/processing` — симуляция обработки (`RandomProcessor`) и интерфейс процессора.
- `internal/backoff` — политика экспоненциального бэкоффа с джиттером.
- `internal/config` — загрузка конфигурации (`WORKERS`, `QUEUE_SIZE`, `ERROR_RATE`).

Фактическая структура может незначительно отличаться, но выше указаны ключевые компоненты.

## Документация

Сгенерировать сводную документацию по проекту (если предусмотрено в `Makefile`):

```bash
make doc
```

Результат — `docs/DOCUMENTATION.md`.

## CI

Пайплайн GitHub Actions (см. `.github/workflows/tests.yml`) запускает покрытие:

- checkout, setup Go 1.24.x
- `go mod tidy`
- `make coverage`
- загрузка артефакта `coverage/`